// Generated by CoffeeScript 1.6.3
$(function() {
  var methods;
  methods = {
    init: function(options) {
      var def, _this;
      if (options == null) {
        options = {};
      }
      def = {
        content: {},
        geo: {
          lat: '',
          lon: '',
          city: '',
          region: '',
          country: ''
        },
        result: {
          key: ''
        }
      };
      $.extend(true, def, options);
      $(this).data('sn', def);
      _this = this;
      $(this).snDemand('geoIp');
      $('#demand-name').live('keyup', function() {
        return $(_this).snDemand('checkName', $(this).val());
      });
      $('#demand-phone').live('keyup', function() {
        return $(_this).snDemand('checkPhone', $(this).val());
      });
      $('#demand-company').live('keyup', function() {
        return $(_this).snDemand('checkCompany', $(this).val());
      });
      $('#demand-comment').live('keyup', function() {
        return $(_this).snDemand('checkComment', $(this).val());
      });
      $('#push-demand').live('click', function() {
        $('#wall-demand').show().css({
          width: $(document).width(),
          height: $(document).height()
        });
        return $('#modal-demand').show();
      });
      $('.modal-header a.close').live('click', function() {
        $('#wall-demand').hide();
        return $('#modal-demand').hide();
      });
      $('#modal-close').live('click', function() {
        $('#wall-demand').hide();
        return $('#modal-demand').hide();
      });
      return $('#modal-send').live('click', function() {
        if ($(this).snDemand('check')) {
          $('.demand-success p').show();
          $('.demand-error p').hide();
          $('#modal-send').hide();
          return $(_this).snDemand('send');
        } else {
          $('.demand-success p').hide();
          return $('.demand-error p').show();
        }
      });
    },
    send: function() {
      var sn;
      sn = $(this).data('sn');
      $(this).snDemand('addToBase');
      return $(this).snDemand('addToGit');
    },
    geoIp: function() {
      var sn, _this;
      _this = this;
      sn = $(this).data('sn');
      return $.ajax({
        url: 'http://j.maxmind.com/app/geoip.js',
        dataType: 'script',
        timeout: 5000,
        success: function() {
          sn.geo = {
            lat: geoip_latitude(),
            lon: geoip_longitude(),
            city: geoip_city(),
            region: geoip_region(),
            country: geoip_country_name()
          };
          return $(_this).data('sn', sn);
        }
      });
    },
    addToBase: function() {
      var dp, sector, sn;
      sn = $(this).data('sn');
      dp = $('[name="demand-type"]:checked').val();
      sector = $('[name="demand-type-' + dp + '"]').val();
      return $.ajax({
        url: 'http://www.standart-n.ru/external/ajax_claim.php',
        type: 'GET',
        data: {
          act: 'add',
          name: $('#demand-name').val(),
          tel: $('#demand-phone').val(),
          email: $('#demand-email').val(),
          comment: $('#demand-comment').val(),
          company: $('#demand-company').val(),
          department: sector,
          skype: '',
          icq: '',
          site: '',
          lat: sn.geo.lat,
          lon: sn.geo.lon,
          city: sn.geo.city,
          region: sn.geo.region,
          country: sn.geo.country
        },
        dataType: 'text',
        timeout: 5000
      });
    },
    addToGit: function() {
      var dp, message, sector, sn;
      sn = $(this).data('sn');
      dp = $('[name="demand-type"]:checked').val();
      sector = $('[name="demand-type-' + dp + '"]').val();
      message = '' + sector + ' ' + $('#demand-company').val() + ' ' + $('#demand-name').val() + ' ' + $('#demand-phone').val() + ' ' + $('#demand-email').val() + ' ' + $('#demand-comment').val() + ' ';
      return sn.geo.city + ' ' + $.ajax({
        url: 'http://git.st-n.ru/',
        type: 'GET',
        data: {
          action: 'addClaim',
          msg: message
        },
        dataType: 'text',
        timeout: 1000
      });
    },
    check: function() {
      var flag;
      flag = true;
      if (!$(this).snDemand('checkName', $('#demand-name').val())) {
        flag = false;
      }
      if (!$(this).snDemand('checkPhone', $('#demand-phone').val())) {
        flag = false;
      }
      if (!$(this).snDemand('checkCompany', $('#demand-company').val())) {
        flag = false;
      }
      if (!$(this).snDemand('checkComment', $('#demand-comment').val())) {
        flag = false;
      }
      return flag;
    },
    checkName: function(val) {
      var flag;
      if (val == null) {
        val = '';
      }
      flag = $(this).snDemand('flagName', val);
      if (flag) {
        $('#validate-name .validate-true').show();
        $('#validate-name .validate-false').hide();
      } else {
        $('#validate-name .validate-true').hide();
        $('#validate-name .validate-false').show();
      }
      return flag;
    },
    checkCompany: function(val) {
      var flag;
      if (val == null) {
        val = '';
      }
      flag = $(this).snDemand('flagCompany', val);
      if (flag) {
        $('#validate-company .validate-true').show();
        $('#validate-company .validate-false').hide();
      } else {
        $('#validate-company .validate-true').hide();
        $('#validate-company .validate-false').show();
      }
      return flag;
    },
    checkPhone: function(val) {
      var flag;
      if (val == null) {
        val = '';
      }
      flag = $(this).snDemand('flagPhone', val);
      if (flag) {
        $('#validate-phone .validate-true').show();
        $('#validate-phone .validate-false').hide();
      } else {
        $('#validate-phone .validate-true').hide();
        $('#validate-phone .validate-false').show();
      }
      return flag;
    },
    checkComment: function(val) {
      var flag;
      if (val == null) {
        val = '';
      }
      flag = $(this).snDemand('flagComment', val);
      if (flag) {
        $('#validate-comment .validate-true').show();
        $('#validate-comment .validate-false').hide();
      } else {
        $('#validate-comment .validate-true').hide();
        $('#validate-comment .validate-false').show();
      }
      return flag;
    },
    flagName: function(val) {
      var flag;
      if (val == null) {
        val = '';
      }
      flag = true;
      if (val === "") {
        flag = false;
      }
      if (val.length < 2 || val.length > 30) {
        flag = false;
      }
      if (!/[^a-z0-9\.\,\"\?\!\;\:\#\$\%\&\(\)\*\+\-\/\<\>\=\@\[\]\\\^\_\{\}\|\~]+/i.test(val)) {
        flag = false;
      }
      return flag;
    },
    flagCompany: function(val) {
      var flag;
      if (val == null) {
        val = '';
      }
      flag = true;
      if (val === "") {
        flag = false;
      }
      if (val.length < 2 || val.length > 30) {
        flag = false;
      }
      return flag;
    },
    flagComment: function(val) {
      var flag;
      if (val == null) {
        val = '';
      }
      flag = true;
      if (val === "") {
        flag = false;
      }
      if (val.length < 2) {
        flag = false;
      }
      return flag;
    },
    flagPhone: function(val) {
      var flag;
      if (val == null) {
        val = '';
      }
      flag = true;
      if (val === "" || val === "+7") {
        flag = false;
      }
      if (val.length < 4 || val.length > 30) {
        flag = false;
      }
      if (!/\+?\d{1,3}(?:\s*\(\d+\)\s*)?(?:(?:\-\d{1,3})+\d|[\d\-]{4,}|(?:\s\d{1,3})+\d)/i.test(val)) {
        flag = false;
      }
      return flag;
    }
  };
  return $.fn.snDemand = function(sn) {
    if (sn == null) {
      sn = {};
    }
    if (methods[sn]) {
      return methods[sn].apply(this, Array.prototype.slice.call(arguments, 1));
    } else {
      if (typeof sn === 'object' || !sn) {
        return methods.init.apply(this, arguments);
      } else {
        return $.error('Метод #{sn} не существует');
      }
    }
  };
});
